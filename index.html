<!--
Bike Mileage Tracker (PWA-ready)
- Local-first (IndexedDB via localforage-like minimal wrapper) ‚Äì here we use localStorage for simplicity.
- Optional cloud sync via Google Sheets (Apps Script) ‚Äì instructions below.
- Works offline; add the service worker + manifest files provided in this doc for PWA support.

FILES IN THIS PROJECT
1) index.html (this file)
2) sw.js (service worker)
3) manifest.webmanifest
4) OPTIONAL: apps-script.gs (Google Apps Script backend)
-->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bike Mileage Tracker</title>
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0ea5e9"/>
  <style>
    :root{--bg:#0b1220;--card:#111827;--muted:#94a3b8;--accent:#0ea5e9;--text:#e5e7eb;--ok:#10b981;--warn:#f59e0b;--err:#ef4444}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:linear-gradient(120deg,#0b1220,#0b1b2e);color:var(--text)}
    header{position:sticky;top:0;background:#0b1423d9;backdrop-filter:blur(6px);border-bottom:1px solid #1f2937;padding:12px 16px;display:flex;gap:10px;align-items:center;z-index:5}
    header h1{font-size:18px;margin:0;font-weight:700}
    .wrap{max-width:920px;margin:20px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:860px){.grid{grid-template-columns:400px 1fr}}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;box-shadow:0 6px 30px #00000040}
    .pad{padding:16px}
    label{font-size:12px;color:var(--muted)}
    input,select,button,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid #1f2937;background:#0b1323;color:var(--text)}
    input:focus,textarea:focus,select:focus{outline:2px solid var(--accent);border-color:transparent}
    .row{display:flex;gap:10px}
    .row>*{flex:1}
    .btn{cursor:pointer;font-weight:600}
    .btn.primary{background:var(--accent);color:#051119;border:none}
    .btn.ghost{background:transparent;border:1px dashed #334155}
    .stat{display:flex;align-items:center;gap:10px;padding:10px 0}
    .stat .v{font-size:22px;font-weight:800}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #1f2937;font-size:14px;text-align:left}
    th{color:var(--muted)}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #1f2937}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    .right{display:flex;gap:8px;margin-left:auto}
    .muted{color:var(--muted)}
    footer{padding:24px;text-align:center;color:var(--muted)}
    .small{font-size:12px}
  </style>
</head>
<body>
<header>
  <h1>üèçÔ∏è Bike Mileage Tracker</h1>
  <div class="right">
    <button id="btnExport" class="btn pill">Export JSON</button>
    <label class="pill" style="padding:0;display:flex;align-items:center;gap:8px;cursor:pointer">
      <input id="fileImport" type="file" accept="application/json" style="display:none"/>
      <span class="muted" style="padding:6px 10px">Import</span>
    </label>
  </div>
</header>

<div class="wrap grid">
  <section class="card pad">
    <h2 style="margin-top:0">‚ûï New Fill‚Äëup / Ride</h2>
    <form id="form">
      <div class="row">
        <div>
          <label>Date & time</label>
          <input type="datetime-local" id="date" required />
        </div>
        <div>
          <label>Odometer (km)</label>
          <input type="number" id="odo" inputmode="decimal" placeholder="e.g. 18250" required />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Fuel added (L)</label>
          <input type="number" id="liters" inputmode="decimal" step="0.01" placeholder="e.g. 7.20" required />
        </div>
        <div>
          <label>Price (‡ß≥) ‚Äî optional</label>
          <input type="number" id="price" inputmode="decimal" step="0.01" placeholder="e.g. 720" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Station / Place</label>
          <input type="text" id="station" placeholder="e.g. Padma Fuel, Mirpur" />
        </div>
        <div>
          <label>Notes</label>
          <input type="text" id="notes" placeholder="e.g. City ride, AC pump" />
        </div>
      </div>
      <div class="row" style="align-items:center">
        <button class="btn primary" type="submit">Save</button>
        <button class="btn ghost" type="button" id="btnClear">Clear All (local)</button>
      </div>
    </form>

    <div class="row" style="margin-top:10px">
      <div class="stat">
        <span class="muted">Avg km/L:</span>
        <span class="v" id="avgKmL">‚Äî</span>
      </div>
      <div class="stat">
        <span class="muted">Avg L/100km:</span>
        <span class="v" id="avgL100">‚Äî</span>
      </div>
      <div class="stat">
        <span class="muted">‡ß≥/km:</span>
        <span class="v" id="costPerKm">‚Äî</span>
      </div>
    </div>
  </section>

  <section class="card pad">
    <h2 style="margin-top:0">üìú History</h2>
    <div class="small muted" style="margin-bottom:8px">Tap any cell to edit in-place. Changes auto-save.</div>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Odo</th>
          <th>L</th>
          <th>‡ß≥</th>
          <th>km/L</th>
          <th>L/100</th>
          <th>‡ß≥/km</th>
          <th>Station</th>
          <th>Notes</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </section>
</div>

<footer class="small">Made for riders. Works offline. Keep backups via Export JSON. Optional cloud sync using Google Sheets below.</footer>

<script>
  // ---------- Storage helpers (localStorage)
  const KEY = 'bike.mileage.v1';
  const $ = sel => document.querySelector(sel);

  const load = () => {
    try{ return JSON.parse(localStorage.getItem(KEY) || '[]'); }catch{ return [] }
  };
  const save = (arr) => localStorage.setItem(KEY, JSON.stringify(arr));

  // ---------- Derived metrics
  const computeRow = (data, i, all) => {
    // km/L uses distance since previous odo
    const prev = all[i-1];
    let dist = null, kml = null, l100 = null, costPerKm = null;
    if (prev && isFinite(data.odo) && isFinite(prev.odo) && isFinite(data.liters) && data.liters>0) {
      dist = data.odo - prev.odo;
      if (dist>0) {
        kml = dist / data.liters;
        l100 = (100 / kml);
        if (isFinite(data.price) && data.price>0) costPerKm = data.price / dist;
      }
    }
    return {dist,kml,l100,costPerKm};
  };

  const fmt = (v, d=2) => (v==null||!isFinite(v))? '‚Äî' : v.toFixed(d);

  // ---------- Render
  const rowsEl = $('#rows');
  function render(){
    const data = load().sort((a,b)=> new Date(a.date) - new Date(b.date));
    rowsEl.innerHTML = '';
    let kmls=[], l100s=[], costKm=[];
    data.forEach((r,i)=>{
      const m = computeRow(r,i,data);
      if (isFinite(m.kml)) kmls.push(m.kml);
      if (isFinite(m.l100)) l100s.push(m.l100);
      if (isFinite(m.costPerKm)) costKm.push(m.costPerKm);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td data-k="date">${new Date(r.date).toLocaleString()}</td>
        <td data-k="odo">${r.odo}</td>
        <td data-k="liters">${r.liters}</td>
        <td data-k="price">${r.price ?? ''}</td>
        <td>${fmt(m.kml)}</td>
        <td>${fmt(m.l100)}</td>
        <td>${fmt(m.costPerKm)}</td>
        <td data-k="station">${r.station ?? ''}</td>
        <td data-k="notes">${r.notes ?? ''}</td>
        <td><button class="btn pill" data-del="${r.id}">‚úï</button></td>
      `;
      rowsEl.appendChild(tr);
    });
    $('#avgKmL').textContent = fmt(avg(kmls));
    $('#avgL100').textContent = fmt(avg(l100s));
    $('#costPerKm').textContent = fmt(avg(costKm));
  }

  const avg = a => a.length? a.reduce((x,y)=>x+y,0)/a.length : NaN;

  // ---------- CRUD
  $('#form').addEventListener('submit', (e)=>{
    e.preventDefault();
    const record = {
      id: crypto.randomUUID(),
      date: $('#date').value || new Date().toISOString(),
      odo: Number($('#odo').value),
      liters: Number($('#liters').value),
      price: $('#price').value? Number($('#price').value) : null,
      station: $('#station').value || '',
      notes: $('#notes').value || ''
    };
    const all = load();
    all.push(record); save(all); render(); e.target.reset();
  });

  rowsEl.addEventListener('click', (e)=>{
    if (e.target.dataset.del){
      const id = e.target.dataset.del;
      const all = load().filter(r=>r.id!==id); save(all); render();
    }
  });

  // in-place edit
  rowsEl.addEventListener('dblclick', (e)=>{
    const cell = e.target.closest('[data-k]');
    if (!cell) return;
    const key = cell.dataset.k;
    const row = cell.parentElement; // tr
    const id = row.querySelector('button[data-del]').dataset.del;
    const old = cell.textContent;
    const input = document.createElement('input');
    input.value = old; input.style.width='100%';
    cell.innerHTML=''; cell.appendChild(input); input.focus();
    input.addEventListener('blur', ()=>{
      const all = load();
      const rec = all.find(x=>x.id===id);
      let val = input.value;
      if(['odo','liters','price'].includes(key)) val = val? Number(val): null;
      if(key==='date') val = new Date(val).toISOString();
      rec[key] = val;
      save(all); render();
    });
  });

  // Export / Import
  $('#btnExport').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(load(),null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'bike-mileage-backup.json';
    a.click();
    URL.revokeObjectURL(a.href);
  });
  $('#fileImport').addEventListener('change', (e)=>{
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{ try{ const arr = JSON.parse(reader.result); save(arr); render(); }catch{ alert('Invalid JSON'); } };
    reader.readAsText(file);
  });

  // Clear local
  $('#btnClear').addEventListener('click', ()=>{
    if (confirm('Delete ALL local data? This cannot be undone.')){ localStorage.removeItem(KEY); render(); }
  });

  // Default datetime
  $('#date').value = new Date().toISOString().slice(0,16);

  // PWA: register service worker if present
  if ('serviceWorker' in navigator){
    window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js'));
  }

  render();
</script>
</body>
</html>


/* ========================= sw.js =========================
self.addEventListener('install', (e)=>{
  e.waitUntil(caches.open('bike-milage-cache-v1').then(cache=> cache.addAll([
    './', './index.html', './manifest.webmanifest'
  ])));
});
self.addEventListener('fetch', (e)=>{
  e.respondWith(caches.match(e.request).then(resp=> resp || fetch(e.request)));
});
========================= END sw.js ========================= */


/* ============== manifest.webmanifest ==============
{
  "name": "Bike Mileage Tracker",
  "short_name": "Mileage",
  "start_url": "./",
  "display": "standalone",
  "background_color": "#0b1220",
  "theme_color": "#0ea5e9",
  "icons": []
}
================= END manifest.webmanifest ============= */


